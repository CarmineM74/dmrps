require 'spec_helper'

describe "/users.json", :type => :api do
  #render_views

  let(:url) { "/users.json" }

  describe 'GET index' do
    it 'fetches all the users from the database' do
      @user = FactoryGirl.create(:user)
      get url
      users = User.all.to_json
      last_response.body.should eql(users)
      last_response.status.should eql(200)
    end
  end

  describe 'POST create' do
    before(:each) do
      @user = FactoryGirl.build(:user)
    end
 
    def do_post
      post :create, :user => {email: @user.email, password: @user.password, password_confirmation: @user.password_confirmation}, :format => 'json'
    end

    context 'with valid parameters' do
      it 'creates an user' do
        expect {
          do_post
        }.to change(User,:count).by(1)
      end

      it 'responds with status 201 (created)' do
        do_post
        response.status.should eq(201)
      end

      it 'renders create.rabl' do
        do_post
        response.should render_template :create
      end
    end

    context 'with invalid parameters' do
      it "doesn't create a new user" do
        @user.email = ''
        lambda {
          do_post
        }.should_not change(User,:count)
      end

      it 'replies with status == :unprocessable_entity (422)' do
        @user.email = ''
        do_post
        response.status.should eq(422)
      end
    end
  end

  describe 'PUT update' do
    before(:each) do
      @user = FactoryGirl.create(:user)
    end

    def do_put(attrs)
      put :update, :id => @user.id, :user => attrs, :format => 'json'
    end

    it 'finds the requested user' do
      do_put(FactoryGirl.attributes_for(:user))
      assigns(:user).should eq(@user)
    end

    context 'with valid parameters' do
      it "replies with status :ok (200)" do
        do_put(FactoryGirl.attributes_for(:user))
        response.status.should eq(200)
      end

      it "updates user's details" do
        do_put(FactoryGirl.attributes_for(:user, email: 'updated@me.com'))
        @user.reload
        @user.email.should eq('updated@me.com')
      end
    end

    context 'with invalid parameters' do
      describe 'replies with status :unprocessable_entity (422)' do
        after(:each) do
          response.status.should eq(422)
        end

        it "when email is empty" do
          do_put(FactoryGirl.attributes_for(:user, email: ''))
        end

        it "when email is already existing" do
          user2 = FactoryGirl.create(:user, email: 'iamme@me.com')
          do_put(FactoryGirl.attributes_for(:user, email: 'iamme@me.com'))
        end

        it "when password is empty" do
          do_put(FactoryGirl.attributes_for(:user, password: ''))
        end

        it "doesn't update user's details" do
          do_put(FactoryGirl.attributes_for(:user, email: ''))
          @user.reload
          @user.email.should_not eq('')
        end
      end

    end
  end

  describe 'DELETE destroy' do
    before(:each) do
      @user = FactoryGirl.create(:user)
    end

    def do_delete
      delete :destroy, id: @user.id, format: 'json'
    end

    it "finds requested user" do
      do_delete
      assigns(:user).should eq(@user)
    end

    context 'when user has been found' do
      it "deletes user from database" do
        expect {
          do_delete
        }.to change(User, :count).by(-1)
        expect {
          User.find(@user.id)
        }.to raise_error(ActiveRecord::RecordNotFound)
      end

      it "replies with status :ok" do
        do_delete
        response.status.should eq(204)
      end
    end

    context 'when user could not be found' do
      it "replies with status :not_found" do
        delete :destroy, id: 200, format: 'json'
        response.status.should eq(404)
      end
    end
  end

end
